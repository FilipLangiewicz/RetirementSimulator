{% extends 'simulator/base.html' %}
{% load static %}

{% block title %}Dashboard - Symulator Emerytalny{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<style>
    /* Timeline wrapper - główny kontener */
    .timeline-wrapper {
        position: relative;
        width: 100%;
        margin: 20px 0;
    }

    /* Timeline container - zmienione z overflow: visible na hidden */
    .timeline-container {
        position: relative;
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden; /* Zmieniono z visible na hidden */
        width: 100%;
        min-height: 180px;
    }

    .timeline-header {
        position: relative;
        height: 40px;
        background: white;
        border-bottom: 2px solid #adb5bd;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
    }

    .timeline-switch {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 12px;
        font-weight: 600;
    }

    .timeline-table {
        display: grid;
        grid-template-columns: repeat(71, 1fr);
        gap: 1px;
        padding: 10px;
        background: #e9ecef;
    }

    /* Overlay dla pionowych linii - WEWNĄTRZ kontenera */
    .timeline-overlay {
        position: absolute;
        top: 0;
        left: 10px;
        right: 10px;
        bottom: 0;
        pointer-events: none;
        z-index: 5;
    }

    /* Przerywana linia */
    .timeline-vertical-line {
        position: absolute;
        width: 2px;
        border-left: 2px dashed;
        opacity: 0.8;
        /* top i height ustawiane przez JS */
    }

    .timeline-vertical-line.current-age-line {
        border-color: rgb(0, 153, 63);
        opacity: 0.9;
    }

    .timeline-vertical-line.legal-retirement-line {
        border-color: rgb(240, 94, 94);
    }

    /* POPRAWIONE: Etykiety pod timelineem - NA ZEWNĄTRZ kontenera */
    .timeline-line-labels {
        width: 100%;
        height: 30px;
        margin-top: 5px; /* Dodano odstęp od timelineu */
        padding: 0 10px; /* Wyrównanie z paddingiem timeline-table */
    }

    .salary-slider {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: #e9ecef;
        outline: none;
        -webkit-appearance: none;
    }

    .salary-slider::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgb(63, 132, 210);
        cursor: pointer;
        border: 2px solid white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .salary-display {
        font-size: 1.5rem;
        font-weight: bold;
        color: rgb(0, 65, 110);
        text-align: center;
        margin: 10px 0;
    }

    .form-check {
    min-height: 0rem;
    margin-bottom: 0rem;
    }

    .timeline-line-label {
        position: absolute;
        font-size: 10px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 3px;
        color: white;
        text-align: center;
        white-space: nowrap;
        transform: translateX(-50%);
        top: 0; /* Etykiety na górze kontenera etykiet */
        transition: transform 0.2s;
    }

    .timeline-line-label:hover {
        transform: translateX(-50%) scale(1.05);
    }

    .timeline-line-label.current-age-label {
        background: rgb(0, 153, 63);
        border: 1px solid rgba(0, 153, 63, 0.8);
    }

    .timeline-line-label.legal-retirement-label {
        background: rgb(240, 94, 94);
        border: 1px solid rgba(240, 94, 94, 0.8);
    }

    .timeline-line-label.planned-retirement-label {
        background: rgb(63, 132, 210);
        border: 1px solid rgba(63, 132, 210, 0.8);
    }

    .year-header {
        background: transparent;
        border: none;
        color: #495057;
        font-size: 8px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 25px;
        user-select: none;
    }

    .year-block {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 600;
        user-select: none;
        height: 35px;
        z-index: 5;
    }

    .year-block:hover {
        background: #e3f2fd;
        border-color: rgb(63, 132, 210);
    }

    .year-block.selecting {
        background: rgba(63, 132, 210, 0.5);
        border-color: rgb(63, 132, 210);
        border-width: 2px;
    }

    .activity-bar {
        position: relative;
        pointer-events: auto;
        height: 35px;
        border-radius: 3px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 600;
        cursor: pointer;
        user-select: none;
        transition: all 0.2s ease;
        border: 1px solid;
        z-index: 10;
    }

    .activity-bar:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .activity-bar.work {
        background: rgb(255, 179, 79);
        color: #333;
        border-color: rgb(255, 179, 79);
    }

    .activity-bar.sick-leave {
        background: rgb(240, 94, 94);
        color: white;
        border-color: rgb(240, 94, 94);
    }

    .activity-bar.break {
        background: rgb(190, 195, 206);
        color: #333;
        border-color: rgb(190, 195, 206);
    }

    /* Context menu */
    .context-menu {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        min-width: 150px;
        display: none;
    }

    .context-menu-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .context-menu-item:last-child {
        border-bottom: none;
    }

    .context-menu-item:hover {
        background: #f8f9fa;
    }

    .context-menu-item.delete {
        color: #dc3545;
    }

    .pension-amount {
        font-size: 3rem;
        font-weight: 700;
        line-height: 1.2;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
    }

    .stat-label {
        font-size: 0.875rem;
        font-weight: 500;
    }

    @media (max-width: 768px) {
        .pension-amount {
            font-size: 2rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
        }
    }

    @media (max-width: 768px) {
        .timeline-table {
            grid-template-columns: repeat(45, 1fr);
        }

        .pension-amount {
            font-size: 2rem;
        }

        .timeline-container {
            min-height: 120px;
        }
    }

</style>
{% endblock %}

<!-- Timeline -->
 {% block content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h3 class="mb-0">
                <i class="bi bi-timeline me-2"></i>
                Oś czasu
            </h3>
            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#helpModal">
                <i class="bi bi-question-circle me-1"></i>
                Pomoc
            </button>
        </div>
        <p class="text-muted mt-2 mb-0">
            {{ first_name }}, opowiedz nam o swojej karierze zawodowej. Przeciągnij myszką, aby zaznaczyć okres. Każdy prostokąt to jeden rok.
        </p>
    </div>
    <div class="card-body">
        <div class="timeline-wrapper">
            <div class="timeline-container" id="timeline-container">
                <!-- Header z przełącznikiem -->
                <div class="timeline-header">
                    <div class="timeline-switch">
                        <span>Wyświetl:</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="timelineMode">
                            <label class="form-check-label" for="timelineMode" id="timelineModeLabel">
                                Wiek życia
                            </label>
                        </div>
                    </div>
                    <div class="text-muted small">
                        <span id="timeline-range">10 - 80 lat</span>
                    </div>
                </div>

                <!-- Tabela timeline -->
                <div class="timeline-table" id="timeline-table">
                    <!-- Wiersz nagłówkowy i wiersze aktywności będą dodawane przez JS -->
                </div>

                <!-- Overlay z pionowymi liniami -->
                <div class="timeline-overlay" id="timeline-overlay">
                    <!-- Linie będą dodawane przez JS -->
                </div>
            </div>

            <!-- PRZENIESIONE NA ZEWNĄTRZ: Etykiety pod timelineem -->
            <div class="timeline-line-labels" id="timeline-line-labels">
                <!-- Etykiety będą dodawane przez JS -->
            </div>
    </div>
</div>
</div>

<!-- Modal wyboru aktywności -->
<div class="modal fade" id="activityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Wybierz typ aktywności</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p class="mb-4">Wybierz, co robiłeś w okresie <strong id="activity-period"></strong>:</p>
                <div class="d-grid gap-3">
                    <button type="button" class="btn btn-lg btn-outline-primary activity-btn" data-activity="work">
                        <i class="bi bi-briefcase me-2"></i>
                        Praca
                    </button>
                    <button type="button" class="btn btn-lg btn-outline-warning activity-btn" data-activity="sick-leave">
                        <i class="bi bi-heart-pulse me-2"></i>
                        Urlop zdrowotny
                    </button>
                    <button type="button" class="btn btn-lg btn-outline-secondary activity-btn" data-activity="break">
                        <i class="bi bi-pause-circle me-2"></i>
                        Przerwa w pracy
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal szczegółów pracy -->
<div class="modal fade" id="workDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Szczegóły pracy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="workDetailsForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Typ umowy</label>
                                <select class="form-select" id="contractType" required>
                                    {% for contract_type in contract_types %}
                                    <option value="{{ contract_type.id }}">{{ contract_type.display_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Okres</label>
                                <input type="text" class="form-control" id="work-period-display" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label">Wynagrodzenie brutto miesięczne</label>
                        <div class="salary-display" id="salary-display">5 000 zł</div>
                        <input type="range" class="salary-slider" id="salarySlider"
                               min="1000" max="50000" step="1000" value="5000">
                        <div class="d-flex justify-content-between text-muted small mt-2">
                            <span>1 000 zł</span>
                            <span>50 000 zł</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn btn-primary" id="saveWorkDetails">Zapisz</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal edycji aktywności -->
<div class="modal fade" id="editActivityModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edytuj aktywność</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editActivityForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Typ aktywności</label>
                                <select class="form-select" id="editActivityType" required>
                                    <option value="work">Praca</option>
                                    <option value="sick-leave">Urlop zdrowotny</option>
                                    <option value="break">Przerwa w pracy</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Okres</label>
                                <input type="text" class="form-control" id="edit-period-display" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Szczegóły pracy -->
                    <div id="editWorkDetails" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Typ umowy</label>
                                    <select class="form-select" id="editContractType">
                                        {% for contract_type in contract_types %}
                                        <option value="{{ contract_type.id }}">{{ contract_type.display_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Wynagrodzenie brutto miesięczne</label>
                            <div class="salary-display" id="edit-salary-display">5 000 zł</div>
                            <input type="range" class="salary-slider" id="editSalarySlider"
                                   min="1000" max="50000" step="1000" value="5000">
                            <div class="d-flex justify-content-between text-muted small mt-2">
                                <span>1 000 zł</span>
                                <span>50 000 zł</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn btn-primary" id="saveEditedActivity">Zapisz zmiany</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal profilu -->
<div class="modal fade" id="profileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edytuj dane osobowe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="profileForm">
                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label class="form-label">Wiek</label>
                                <input type="number" class="form-control" id="profileAge" value="{{ profile.age }}" min="18" max="80">
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label class="form-label">Płeć</label>
                                <select class="form-control" id="profileGender">
                                    <option value="M" {% if profile.gender == 'M' %}selected{% endif %}>Mężczyzna</option>
                                    <option value="K" {% if profile.gender == 'K' %}selected{% endif %}>Kobieta</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Planowany rok emerytury</label>
                        <input type="number" class="form-control" id="profileRetirementYear" value="{{ profile.planned_retirement_year }}">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn btn-primary" id="saveProfile">Zapisz</button>
            </div>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Instrukcja obsługi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Jak dodać aktywność:</h6>
                <ol>
                    <li>Naciśnij i przytrzymaj lewy przycisk myszy na pierwszym roku</li>
                    <li>Przeciągnij w prawo, aby zaznaczyć kolejne lata</li>
                    <li>Puść przycisk - otworzy się okno wyboru aktywności</li>
                    <li>Wybierz typ: Praca, Urlop zdrowotny lub Przerwa w pracy</li>
                    <li>Jeśli wybrałeś "Praca", uzupełnij szczegóły w kolejnym oknie</li>
                </ol>
                <h6 class="mt-4">Jak edytować aktywność:</h6>
                <ol>
                    <li>Kliknij prawym przyciskiem myszy na prostokąt aktywności</li>
                    <li>Wybierz "Edytuj" lub "Usuń" z menu kontekstowego</li>
                </ol>
                <h6 class="mt-4">Przełącznik wyświetlania:</h6>
                <p>Użyj przełącznika w prawym górnym rogu timeline, aby zmieniać między widokiem wieku życia (10-80 lat) a latami kalendarzowymi.</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal edycji aktywności -->
<div class="modal fade" id="editActivityModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edytuj aktywność</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editActivityForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Typ aktywności</label>
                                <select class="form-select" id="editActivityType" required>
                                    <option value="work">Praca</option>
                                    <option value="sick-leave">Urlop zdrowotny</option>
                                    <option value="break">Przerwa w pracy</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Okres</label>
                                <input type="text" class="form-control" id="edit-period-display" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Szczegóły pracy -->
                    <div id="editWorkDetails" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Typ umowy</label>
                                    <select class="form-select" id="editContractType">
                                        <option value="1">Umowa o pracę</option>
                                        <option value="2">Umowa zlecenie</option>
                                        <option value="3">Umowa o dzieło</option>
                                        <option value="4">Działalność gospodarcza (B2B)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Wynagrodzenie brutto miesięczne</label>
                            <div class="salary-display" id="edit-salary-display">5 000 zł</div>
                            <input type="range" class="salary-slider" id="editSalarySlider"
                                   min="1000" max="50000" step="1000" value="5000">
                            <div class="d-flex justify-content-between text-muted small mt-2">
                                <span>1 000 zł</span>
                                <span>50 000 zł</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="deleteActivityBtn">
                    <i class="bi bi-trash me-1"></i>
                    Usuń
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn btn-primary" id="saveEditedActivity">Zapisz zmiany</button>
            </div>
        </div>
    </div>
</div>

<!-- Context menu -->
<div class="context-menu" id="contextMenu">
    <div class="context-menu-item" id="editActivity">
        <i class="bi bi-pencil"></i>
        Edytuj
    </div>
    <div class="context-menu-item delete" id="deleteActivity">
        <i class="bi bi-trash"></i>
        Usuń
    </div>
</div>

<!-- Duży kafelik z emeryturą -->
<div class="container mt-3" style="max-width: 900px;">
    <div class="card mb-4 shadow-lg border-0">
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h3 class="mb-3 text-dark">
                        <i class="bi bi-calculator me-2 text-success"></i>
                        Twoja prognozowana emerytura
                    </h3>
                    <div class="pension-amount text-success mb-2" id="pension-amount">
                        {{ formatted_pension }}
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-outline-success btn-lg" data-bs-toggle="modal" data-bs-target="#profileModal">
                        <i class="bi bi-person-gear me-2"></i>
                        Edytuj dane
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mniejsze kafelki ze statystykami -->
<div class="row g-3 mb-4">
    <div class="col-md-3 col-sm-6">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-body text-center p-3">
                <div class="stat-value text-success mb-2" id="work-years">
                    {{ pension_data.total_work_years|default:0 }}
                </div>
                <div class="stat-label text-muted small">Lat pracy</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-body text-center p-3">
                <div class="stat-value text-success mb-2" id="retirement-age">
                    {{ pension_data.retirement_age|default:0 }}
                </div>
                <div class="stat-label text-muted small">Wiek przejścia na emeryturę</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-body text-center p-3">
                <div class="stat-value text-success mb-2" id="total-contributions">
                    {{ pension_data.total_contributions|floatformat:0|default:0 }} zł
                </div>
                <div class="stat-label text-muted small">Suma składek</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-body text-center p-3">
                <div class="stat-value text-success mb-2" id="current-age">
                    {{ profile.age }}
                </div>
                <div class="stat-label text-muted small">Obecny wiek</div>
            </div>
        </div>
    </div>
</div>

<!-- Piramida potrzeb emerytalnych -->
{% if pension_data.monthly_pension > 0 %}
<div class="container mt-5 mb-5" style="max-width: 1000px;">
    <div class="card shadow-lg border-0">
        <div class="card-body p-4">
            <h3 class="mb-4 text-center text-dark">
                <i class="bi bi-layers me-2 text-success"></i>
                Poziom zabezpieczenia emerytalnego
            </h3>
            
            <div class="row align-items-center">
                <div class="col-md-5 text-center mb-4 mb-md-0">
                    <img src="{% static 'simulator/img/piramida' %}{{ pyramid_level }}.png" 
                         alt="Piramida potrzeb - poziom {{ pyramid_level }}" 
                         class="img-fluid rounded shadow"
                         style="max-height: 400px;">
                </div>
                
                <div class="col-md-7">
                    <div class="border-start border-5 {{ pyramid_border_class }} ps-4">
                        <h5 class="{{ pyramid_text_class }} mb-3">{{ pyramid_title }}</h5>
                        <p class="text-dark mb-3">{{ pyramid_description }}</p>
                        <div class="mt-3 p-3 bg-light rounded">
                            <small class="text-muted">
                                <strong>Przedział:</strong> {{ pyramid_range }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script type="application/json" id="timeline-data">{{ timeline_data_json|safe }}</script>
<script>
// Funkcja określająca poziom piramidy na podstawie kwoty emerytury
function getPyramidLevel(pension) {
    const levels = [
        {
            max: 1000,
            level: 0,
            title: 'Warstwa 0 – Brak zabezpieczenia',
            description: 'Przy emeryturze w wysokości od 0 do 1000 zł miesięcznie nie będziesz w stanie zaspokoić nawet podstawowych potrzeb. Nie starczy Ci na jedzenie, leki, mieszkanie ani opłaty za rachunki. Taka kwota nie pozwoli na samodzielne funkcjonowanie i oznacza całkowitą zależność od pomocy bliskich lub wsparcia społecznego.',
            range: '0 - 1 000 zł',
            textClass: 'text-danger',
            borderClass: 'border-danger'
        },
        {
            max: 2000,
            level: 1,
            title: 'Warstwa 1 – Podstawowe potrzeby',
            description: 'Przy emeryturze w wysokości od 1 000 do 2 000 zł miesięcznie będziesz w stanie pokryć jedynie najprostsze potrzeby, takie jak zakup chleba, mleka, warzyw, mięsa i podstawowych leków. Zabraknie Ci pieniędzy na czynsz, rachunki, transport czy ubrania.',
            range: '1 000 - 2 000 zł',
            textClass: 'text-warning',
            borderClass: 'border-warning'
        },
        {
            max: 3500,
            level: 2,
            title: 'Warstwa 2 – Mieszkanie i rachunki',
            description: 'Emerytura w przedziale od 2 000 do 3 500 zł pozwoli Ci opłacić mieszkanie, rachunki za prąd, gaz i wodę, a także zapewnić podstawowe jedzenie oraz leki. Będziesz mógł pokryć koszty podstawowego transportu. Zabraknie Ci jednak pieniędzy na dodatkowe leczenie, zakup nowych ubrań czy podstawowe formy rozrywki.',
            range: '2 000 - 3 500 zł',
            textClass: 'text-info',
            borderClass: 'border-info'
        },
        {
            max: 6000,
            level: 3,
            title: 'Warstwa 3 – Zdrowie i codzienny komfort',
            description: 'Przy emeryturze wynoszącej od 3 500 do 6 000 zł będziesz mógł pokryć wszystkie podstawowe koszty życia, w tym mieszkanie, rachunki, transport i lepszej jakości jedzenie. Będziesz miał możliwość zakupu ubrań i obuwia, opłacenia internetu i telefonu oraz pokrycia kosztów podstawowych badań i leków. Zabraknie Ci jednak środków na wakacje, hobby czy zakupy o charakterze luksusowym.',
            range: '3 500 - 6 000 zł',
            textClass: 'text-primary',
            borderClass: 'border-primary'
        },
        {
            max: 10000,
            level: 4,
            title: 'Warstwa 4 – Rozrywka i wypoczynek',
            description: 'Emerytura w przedziale od 6 000 do 10 000 zł pozwoli Ci nie tylko pokryć wszystkie niezbędne wydatki, lecz także zapewni dodatkowy komfort. Będziesz mógł chodzić do kina, teatru czy restauracji, pozwolić sobie na krótkie wakacje w Polsce oraz rozwijać hobby. Nadal jednak zabraknie Ci środków na regularne wakacje zagraniczne, nowy samochód czy drogie prezenty.',
            range: '6 000 - 10 000 zł',
            textClass: 'text-success',
            borderClass: 'border-success'
        },
        {
            max: Infinity,
            level: 5,
            title: 'Warstwa 5 – Luksus',
            description: 'Emerytura w wysokości powyżej 10 000 zł zapewni Ci pełny komfort życia. Będziesz mógł realizować wszystkie potrzeby, w tym podróże zagraniczne, zakup nowego samochodu, korzystanie z dóbr luksusowych, rozwijanie hobby i kupowanie prezentów dla bliskich. Na tym poziomie Twoja emerytura nie będzie w zasadzie ograniczać możliwości konsumpcji.',
            range: 'powyżej 10 000 zł',
            textClass: 'text-success',
            borderClass: 'border-success'
        }
    ];
    
    for (let levelData of levels) {
        if (pension <= levelData.max) {
            return levelData;
        }
    }
    return levels[levels.length - 1];
}

// Funkcja aktualizująca piramidę
function updatePyramid() {
    const pensionElement = document.getElementById('pension-amount');
    if (!pensionElement) return;
    
    // Odczytaj tekst i wyciągnij liczbę (usuń spacje i "zł")
    const pensionText = pensionElement.textContent.trim();
    const pensionAmount = parseInt(pensionText.replace(/\s/g, '').replace('zł', '')) || 0;
    
    // Pobierz informacje o poziomie
    const pyramidInfo = getPyramidLevel(pensionAmount);
    
    // Zaktualizuj elementy na stronie
    const pyramidContainer = document.querySelector('.container.mt-5.mb-5');
    if (pyramidContainer && pensionAmount > 0) {
        pyramidContainer.style.display = 'block';
        
        // Zaktualizuj obrazek
        const img = pyramidContainer.querySelector('img');
        if (img) {
            img.src = "{% static 'simulator/img/piramida' %}" + pyramidInfo.level + ".png";
            img.alt = "Piramida potrzeb - poziom " + pyramidInfo.level;
        }
        
        // Zaktualizuj tytuł
        const title = pyramidContainer.querySelector('h5');
        if (title) {
            title.textContent = pyramidInfo.title;
            title.className = pyramidInfo.textClass + ' mb-3';
        }
        
        // Zaktualizuj opis
        const description = pyramidContainer.querySelector('p.text-dark');
        if (description) {
            description.textContent = pyramidInfo.description;
        }
        
        // Zaktualizuj zakres
        const range = pyramidContainer.querySelector('small strong');
        if (range && range.nextSibling) {
            range.nextSibling.textContent = ' ' + pyramidInfo.range;
        }
        
        // Zaktualizuj border
        const border = pyramidContainer.querySelector('.border-start');
        if (border) {
            border.className = 'border-start border-5 ' + pyramidInfo.borderClass + ' ps-4';
        }
    } else if (pyramidContainer) {
        pyramidContainer.style.display = 'none';
    }
}

// Uruchom aktualizację po załadowaniu strony
document.addEventListener('DOMContentLoaded', updatePyramid);

// Obserwuj zmiany w elemencie pension-amount
const pensionObserver = new MutationObserver(updatePyramid);
const pensionElement = document.getElementById('pension-amount');
if (pensionElement) {
    pensionObserver.observe(pensionElement, { 
        childList: true, 
        characterData: true, 
        subtree: true 
    });
}
</script>

{% endblock %}

{% block extra_js %}
<script src="{% static 'simulator/js/timeline.js' %}"></script>
{% endblock %}
