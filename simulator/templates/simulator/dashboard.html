{% extends 'simulator/base.html' %}
{% load static %}

{% block title %}Dashboard - Symulator Emerytalny{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<style>
    .pension-summary {
        background: linear-gradient(135deg, rgb(0, 65, 110) 0%, rgb(63, 132, 210) 100%);
        color: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
    }

    .pension-amount {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .timeline-container {
        position: relative;
        height: 400px;
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        margin: 20px 0;
        width: 100%;
    }

    .timeline {
        position: relative;
        height: 100%;
        width: 100%;
        background: linear-gradient(90deg, #e9ecef 0%, #f8f9fa 50%, #e9ecef 100%);
    }

    .timeline-year-labels {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 50px;
        border-bottom: 2px solid #adb5bd;
        background: white;
        z-index: 10;
    }

    .age-label {
        position: absolute;
        top: 15px;
        font-size: 12px;
        font-weight: 600;
        transform: translateX(-50%);
        user-select: none;
        color: #495057;
    }

    .timeline-line {
        position: absolute;
        top: 50px;
        bottom: 0;
        width: 3px;
        z-index: 5;
        border-radius: 2px;
    }

    .current-age-line {
        background: rgb(0, 153, 63);
        box-shadow: 0 0 10px rgba(0, 153, 63, 0.5);
    }

    .legal-retirement-line {
        background: rgb(240, 94, 94);
        box-shadow: 0 0 10px rgba(240, 94, 94, 0.5);
    }

    .planned-retirement-line {
        background: rgb(63, 132, 210);
        box-shadow: 0 0 10px rgba(63, 132, 210, 0.5);
        cursor: ew-resize;
    }

    .work-period {
        position: absolute;
        top: 70px;
        height: 80px;
        border-radius: 8px;
        cursor: pointer;
        border: 3px solid transparent;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 700;
        color: white;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
        z-index: 8;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .work-period:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        border-color: white;
    }

    .work-period.employment { background: rgb(255, 179, 79); }
    .work-period.mandate { background: rgb(0, 153, 63); }
    .work-period.task { background: rgb(190, 195, 206); color: #333; }
    .work-period.business { background: rgb(63, 132, 210); }
    .work-period.b2b { background: rgb(0, 65, 110); }

    .timeline-selection {
        position: absolute;
        top: 70px;
        height: 80px;
        background: rgba(63, 132, 210, 0.3);
        border: 3px dashed rgb(63, 132, 210);
        border-radius: 8px;
        display: none;
        z-index: 6;
    }

    .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 20px;
        padding: 20px;
        background: white;
        border-radius: 12px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 500;
    }

    .legend-color {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: rgb(0, 65, 110);
        margin-bottom: 5px;
    }

    .stat-label {
        color: #6c757d;
        font-weight: 500;
    }

    @media (max-width: 768px) {
        .pension-amount {
            font-size: 2rem;
        }

        .timeline-container {
            height: 300px;
        }

        .work-period {
            height: 60px;
            font-size: 11px;
        }

        .timeline-selection {
            height: 60px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Podsumowanie emerytury na górze -->
<div class="pension-summary">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h2 class="mb-3">
                <i class="bi bi-calculator me-2"></i>
                Twoja prognozowana emerytura
            </h2>
            <div class="pension-amount" id="pension-amount">
                {{ formatted_pension }}
            </div>
            <p class="mb-0 opacity-75">miesięcznie brutto</p>
        </div>
        <div class="col-md-4">
            <div class="text-end">
                <button class="btn btn-outline-light btn-lg" data-bs-toggle="modal" data-bs-target="#profileModal">
                    <i class="bi bi-person-gear me-2"></i>
                    Edytuj dane
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Statystyki -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value" id="work-years">{{ pension_data.total_work_years|default:0 }}</div>
        <div class="stat-label">Lat pracy</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="retirement-age">{{ pension_data.retirement_age|default:0 }}</div>
        <div class="stat-label">Wiek emerytury</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="total-contributions">{{ pension_data.total_contributions|floatformat:0|default:0 }}</div>
        <div class="stat-label">Suma składek (zł)</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="current-age">{{ profile.age|default:30 }}</div>
        <div class="stat-label">Obecny wiek</div>
    </div>
</div>

<!-- Główny timeline na całą szerokość -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h3 class="mb-0">
                <i class="bi bi-timeline me-2"></i>
                Timeline życia zawodowego
            </h3>
            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#helpModal">
                <i class="bi bi-question-circle me-1"></i>
                Pomoc
            </button>
        </div>
        <p class="text-muted mt-2 mb-0">
            Przeciągnij myszką aby zaznaczyć okres pracy. Kliknij na istniejący okres aby go edytować.
        </p>
    </div>
    <div class="card-body">
        <div class="timeline-container" id="timeline-container">
            <div class="timeline" id="timeline">
                <!-- Age labels -->
                <div class="timeline-year-labels" id="age-labels"></div>

                <!-- Timeline lines -->
                <div class="timeline-line current-age-line" id="current-age-line"></div>
                <div class="timeline-line legal-retirement-line" id="legal-retirement-line"></div>
                <div class="timeline-line planned-retirement-line" id="planned-retirement-line"></div>

                <!-- Selection area -->
                <div class="timeline-selection" id="timeline-selection"></div>

                <!-- Work periods will be added here dynamically -->
            </div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color current-age-line"></div>
                <span>Obecny wiek ({{ profile.age|default:30 }} lat)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legal-retirement-line"></div>
                <span>Prawny wiek emerytalny ({{ profile.retirement_age_legal|default:65 }} lat)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color planned-retirement-line"></div>
                <span>Planowana emerytura (przeciągalna)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color employment"></div>
                <span>Umowa o pracę</span>
            </div>
            <div class="legend-item">
                <div class="legend-color mandate"></div>
                <span>Umowa zlecenie</span>
            </div>
            <div class="legend-item">
                <div class="legend-color business"></div>
                <span>Działalność gospodarcza</span>
            </div>
            <div class="legend-item">
                <div class="legend-color task"></div>
                <span>Umowa o dzieło</span>
            </div>
            <div class="legend-item">
                <div class="legend-color b2b"></div>
                <span>Umowa B2B</span>
            </div>
        </div>
    </div>
</div>

<!-- Modal for profile editing -->
<div class="modal fade" id="profileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edytuj dane osobowe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="profileForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Wiek</label>
                                <input type="number" class="form-control" id="profileAge" value="{{ profile.age|default:30 }}" min="18" max="80">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Płeć</label>
                                <select class="form-control" id="profileGender">
                                    <option value="M" {% if profile.gender == 'M' %}selected{% endif %}>Mężczyzna</option>
                                    <option value="K" {% if profile.gender == 'K' %}selected{% endif %}>Kobieta</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Planowany rok emerytury</label>
                        <input type="number" class="form-control" id="profileRetirementYear" value="{{ profile.planned_retirement_year|default:2060 }}">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn btn-primary" id="saveProfile">Zapisz</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for adding/editing work periods -->
<div class="modal fade" id="workPeriodModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="workPeriodModalTitle">Dodaj okres pracy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="workPeriodForm">
                    <div class="mb-3">
                        <label for="contractType" class="form-label">Typ umowy</label>
                        <select class="form-control" id="contractType" required>
                            {% for contract_type in contract_types %}
                            <option value="{{ contract_type.id }}">{{ contract_type.display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="startAge" class="form-label">Wiek rozpoczęcia</label>
                                <input type="number" class="form-control" id="startAge" readonly>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="endAge" class="form-label">Wiek zakończenia</label>
                                <input type="number" class="form-control" id="endAge" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="salaryGross" class="form-label">Wynagrodzenie brutto miesięczne (zł)</label>
                        <input type="number" class="form-control" id="salaryGross" step="0.01" min="0" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn btn-danger" id="deleteWorkPeriod" style="display: none;">Usuń</button>
                <button type="button" class="btn btn-primary" id="saveWorkPeriod">Zapisz</button>
            </div>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Instrukcja obsługi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Jak dodać okres pracy:</h6>
                <ol>
                    <li>Naciśnij i przytrzymaj lewy przycisk myszy na timeline</li>
                    <li>Przeciągnij aby zaznaczyć okres (wiek od-do)</li>
                    <li>Puść przycisk - otworzy się okno do wprowadzenia danych</li>
                    <li>Wybierz typ umowy i wprowadź wynagrodzenie</li>
                    <li>Kliknij "Zapisz"</li>
                </ol>

                <h6 class="mt-4">Jak edytować okres pracy:</h6>
                <ol>
                    <li>Kliknij na istniejący okres pracy na timeline</li>
                    <li>Zmień dane w oknie dialogowym</li>
                    <li>Kliknij "Zapisz" lub "Usuń"</li>
                </ol>

                <h6 class="mt-4">Przesuwanie planowanej emerytury:</h6>
                <p>Niebieską linię planowanej emerytury można przeciągać w poziomie aby zmienić planowany wiek przejścia na emeryturę.</p>
            </div>
        </div>
    </div>
</div>

<!-- Timeline data for JavaScript -->
<script type="application/json" id="timeline-data">{{ timeline_data_json|safe }}</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'simulator/js/timeline.js' %}"></script>
{% endblock %}