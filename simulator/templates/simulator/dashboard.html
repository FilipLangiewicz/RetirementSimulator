{% extends 'simulator/base.html' %}
{% load static %}

{% block title %}Dashboard - Symulator Emerytalny{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<style>
    .pension-summary {
        background: linear-gradient(135deg, rgb(0, 65, 110) 0%, rgb(63, 132, 210) 100%);
        color: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
    }

    .pension-amount {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 10px;
    }

    /* Nowy timeline - prostokąty dla każdego roku */
    .timeline-container {
        position: relative;
        height: 250px;
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        margin: 20px 0;
        width: 100%;
    }

    .timeline-header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 40px;
        background: white;
        border-bottom: 2px solid #adb5bd;
        z-index: 10;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
    }

    .timeline-switch {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 12px;
        font-weight: 600;
    }

    .timeline-grid {
        position: absolute;
        top: 40px;
        left: 10px;
        right: 10px;
        bottom: 10px;
        display: grid;
        grid-template-columns: repeat(90, 1fr); /* 90 lat (10-100) */
        gap: 1px;
        background: #e9ecef;
        padding: 10px;
        border-radius: 0 0 6px 6px;
    }

    .year-block {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 3px;
        position: relative;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 600;
        user-select: none;
    }

    .year-block:hover {
        background: #e3f2fd;
        border-color: rgb(63, 132, 210);
    }

    .year-block.current-age {
        background: rgb(0, 153, 63);
        color: white;
        border-color: rgb(0, 153, 63);
    }

    .year-block.legal-retirement {
        background: rgb(240, 94, 94);
        color: white;
        border-color: rgb(240, 94, 94);
    }

    .year-block.planned-retirement {
        background: rgb(63, 132, 210);
        color: white;
        border-color: rgb(63, 132, 210);
    }

    /* Aktywności na timeline */
    .year-block.work {
        background: rgb(255, 179, 79);
        color: #333;
        border-color: rgb(255, 179, 79);
    }

    .year-block.sick-leave {
        background: rgb(240, 94, 94);
        color: white;
        border-color: rgb(240, 94, 94);
    }

    .year-block.break {
        background: rgb(190, 195, 206);
        color: #333;
        border-color: rgb(190, 195, 206);
    }

    .year-block.selecting {
        background: rgba(63, 132, 210, 0.5);
        border-color: rgb(63, 132, 210);
        border-width: 2px;
    }

    /* Etykiety lat */
    .year-labels {
        position: absolute;
        top: 40px;
        left: 10px;
        right: 10px;
        height: 20px;
        display: grid;
        grid-template-columns: repeat(90, 1fr);
        gap: 1px;
        padding: 0 10px;
        z-index: 5;
    }

    .year-label {
        font-size: 8px;
        text-align: center;
        color: #6c757d;
        font-weight: 500;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: rgb(0, 65, 110);
        margin-bottom: 5px;
    }

    .stat-label {
        color: #6c757d;
        font-weight: 500;
    }

    .legend {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
        padding: 20px;
        background: white;
        border-radius: 12px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 500;
        font-size: 14px;
    }

    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    /* Range slider style */
    .salary-slider {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: #e9ecef;
        outline: none;
        -webkit-appearance: none;
    }

    .salary-slider::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgb(63, 132, 210);
        cursor: pointer;
        border: 2px solid white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .salary-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgb(63, 132, 210);
        cursor: pointer;
        border: 2px solid white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .salary-display {
        font-size: 1.5rem;
        font-weight: bold;
        color: rgb(0, 65, 110);
        text-align: center;
        margin: 10px 0;
    }

    @media (max-width: 768px) {
        .timeline-grid {
            grid-template-columns: repeat(45, 1fr); /* Mniej kolumn na mobile */
        }

        .year-labels {
            grid-template-columns: repeat(45, 1fr);
        }

        .pension-amount {
            font-size: 2rem;
        }

        .timeline-container {
            height: 200px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Podsumowanie emerytury na górze -->
<div class="pension-summary">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h2 class="mb-3">
                <i class="bi bi-calculator me-2"></i>
                Twoja prognozowana emerytura
            </h2>
            <div class="pension-amount" id="pension-amount">
                {{ formatted_pension }}
            </div>
            <p class="mb-0 opacity-75">miesięcznie brutto</p>
        </div>
        <div class="col-md-4">
            <div class="text-end">
                <button class="btn btn-outline-light btn-lg" data-bs-toggle="modal" data-bs-target="#profileModal">
                    <i class="bi bi-person-gear me-2"></i>
                    Edytuj dane
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Statystyki -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value" id="work-years">{{ pension_data.total_work_years|default:0 }}</div>
        <div class="stat-label">Lat pracy</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="retirement-age">{{ pension_data.retirement_age|default:0 }}</div>
        <div class="stat-label">Wiek emerytury</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="total-contributions">{{ pension_data.total_contributions|floatformat:0|default:0 }}</div>
        <div class="stat-label">Suma składek (zł)</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="current-age">{{ profile.age }}</div>
        <div class="stat-label">Obecny wiek</div>
    </div>
</div>

<!-- Główny timeline na całą szerokość -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h3 class="mb-0">
                <i class="bi bi-timeline me-2"></i>
                Timeline życia zawodowego
            </h3>
            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#helpModal">
                <i class="bi bi-question-circle me-1"></i>
                Pomoc
            </button>
        </div>
        <p class="text-muted mt-2 mb-0">
            Przeciągnij myszką aby zaznaczyć okres. Każdy prostokąt to jeden rok.
        </p>
    </div>
    <div class="card-body">
        <div class="timeline-container" id="timeline-container">
            <!-- Header z przełącznikiem -->
            <div class="timeline-header">
                <div class="timeline-switch">
                    <span>Wyświetl:</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="timelineMode">
                        <label class="form-check-label" for="timelineMode" id="timelineModeLabel">
                            Wiek życia
                        </label>
                    </div>
                </div>
                <div class="text-muted small">
                    <span id="timeline-range">10 - 100 lat</span>
                </div>
            </div>

            <!-- Etykiety lat -->
            <div class="year-labels" id="year-labels"></div>

            <!-- Siatka prostokątów -->
            <div class="timeline-grid" id="timeline-grid"></div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color current-age"></div>
                <span>Obecny wiek</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legal-retirement"></div>
                <span>Prawny wiek emerytalny</span>
            </div>
            <div class="legend-item">
                <div class="legend-color planned-retirement"></div>
                <span>Planowana emerytura</span>
            </div>
            <div class="legend-item">
                <div class="legend-color work"></div>
                <span>Praca</span>
            </div>
            <div class="legend-item">
                <div class="legend-color sick-leave"></div>
                <span>Urlop zdrowotny</span>
            </div>
            <div class="legend-item">
                <div class="legend-color break"></div>
                <span>Przerwa w pracy</span>
            </div>
        </div>
    </div>
</div>

<!-- Modal wyboru aktywności (pierwszy krok) -->
<div class="modal fade" id="activityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Wybierz typ aktywności</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p class="mb-4">Wybierz, co robiłeś w okresie <strong id="activity-period"></strong>:</p>

                <div class="d-grid gap-3">
                    <button type="button" class="btn btn-lg btn-outline-primary activity-btn" data-activity="work">
                        <i class="bi bi-briefcase me-2"></i>
                        Praca
                    </button>
                    <button type="button" class="btn btn-lg btn-outline-warning activity-btn" data-activity="sick-leave">
                        <i class="bi bi-heart-pulse me-2"></i>
                        Urlop zdrowotny
                    </button>
                    <button type="button" class="btn btn-lg btn-outline-secondary activity-btn" data-activity="break">
                        <i class="bi bi-pause-circle me-2"></i>
                        Przerwa w pracy
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal szczegółów pracy (drugi krok) -->
<div class="modal fade" id="workDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Szczegóły pracy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="workDetailsForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Typ umowy</label>
                                <select class="form-select" id="contractType" required>
                                    {% for contract_type in contract_types %}
                                    <option value="{{ contract_type.id }}">{{ contract_type.display_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Okres</label>
                                <input type="text" class="form-control" id="work-period-display" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Wynagrodzenie brutto miesięczne</label>
                        <div class="salary-display" id="salary-display">5 000 zł</div>
                        <input type="range" class="salary-slider" id="salarySlider"
                               min="1000" max="50000" step="1000" value="5000">
                        <div class="d-flex justify-content-between text-muted small mt-2">
                            <span>1 000 zł</span>
                            <span>50 000 zł</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn btn-primary" id="saveWorkDetails">Zapisz</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal edycji profilu -->
<div class="modal fade" id="profileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edytuj dane osobowe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="profileForm">
                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label class="form-label">Wiek</label>
                                <input type="number" class="form-control" id="profileAge" value="{{ profile.age }}" min="18" max="80">
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label class="form-label">Płeć</label>
                                <select class="form-control" id="profileGender">
                                    <option value="M" {% if profile.gender == 'M' %}selected{% endif %}>Mężczyzna</option>
                                    <option value="K" {% if profile.gender == 'K' %}selected{% endif %}>Kobieta</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Planowany rok emerytury</label>
                        <input type="number" class="form-control" id="profileRetirementYear" value="{{ profile.planned_retirement_year }}">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn btn-primary" id="saveProfile">Zapisz</button>
            </div>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Instrukcja obsługi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Jak dodać aktywność:</h6>
                <ol>
                    <li>Naciśnij i przytrzymaj lewy przycisk myszy na pierwszym roku</li>
                    <li>Przeciągnij w prawo, aby zaznaczyć kolejne lata</li>
                    <li>Puść przycisk - otworzy się okno wyboru aktywności</li>
                    <li>Wybierz typ: Praca, Urlop zdrowotny lub Przerwa w pracy</li>
                    <li>Jeśli wybrałeś "Praca", uzupełnij szczegóły w kolejnym oknie</li>
                </ol>

                <h6 class="mt-4">Przełącznik wyświetlania:</h6>
                <p>Użyj przełącznika w prawym górnym rogu timeline, aby zmieniać między widokiem wieku życia (10-100 lat) a latami kalendarzowymi.</p>

                <h6 class="mt-4">Edycja profilu:</h6>
                <p>Kliknij przycisk "Edytuj dane" aby zmienić swój wiek, płeć i planowany rok emerytury.</p>
            </div>
        </div>
    </div>
</div>

<!-- Timeline data for JavaScript -->
<script type="application/json" id="timeline-data">{{ timeline_data_json|safe }}</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'simulator/js/timeline.js' %}"></script>
{% endblock %}